# Тестовое задание: Semantic Search API для PDF-документов

## Описание

Разработать REST API на Python с использованием FastAPI для семантического поиска по содержимому PDF-документов.
Система должна извлекать текст из PDF, генерировать векторные эмбеддинги через Ollama и хранить их в Milvus для последующего поиска по смыслу.

## Инструкции по выполнению
1. Подготовьте репозиторий с README.
2. Настройте окружение с использованием Docker & Docker Compose.
3. Разработайте API в соответствии с описанными требованиями.
4. Добавьте тесты (unit), логи и метрики.
5. Оформите документацию API с помощью Swagger.
6. Предоставьте инструкции по запуску (Makefile, README).

## Технологический стек
1. **Язык разработки**: Python (FastAPI)
2. **Векторная база данных**: Milvus
3. **База данных**: PostgreSQL (хранение пользователей)
4. **LLM/Embeddings**: Ollama (модель для эмбеддингов, например nomic-embed-text)
5. **Парсинг PDF**: PyMuPDF (fitz) или pdfplumber
6. **Аутентификация**: JWT (JSON Web Token)
7. **Документация**: Swagger/OpenAPI
8. **Тесты**: Unit-тесты (pytest)
9. **Docker**: Dockerfile и docker-compose для развертывания
10. **Логирование**: structlog

## Функциональные требования

### 1. Регистрация и аутентификация пользователей

- Регистрация с логином и паролем.
- Аутентификация через JWT-токен.
- Пароли хранятся в безопасном виде (bcrypt).
- Access token с ограниченным сроком действия.
- Все эндпоинты, кроме регистрации и логина, требуют валидный JWT.

### 2. Загрузка PDF-документов

- Эндпоинт для загрузки PDF-файлов.
- Извлечение текста из PDF.
- Разбиение текста на чанки (chunks) с настраиваемым размером и перекрытием.
- Генерация векторных эмбеддингов для каждого чанка через Ollama.
- Сохранение эмбеддингов и метаданных в Milvus.

### 3. Семантический поиск

- Эндпоинт для поиска по текстовому запросу.
- Генерация эмбеддинга запроса через Ollama.
- Поиск ближайших векторов в Milvus (similarity search).
- Возврат релевантных фрагментов текста с указанием исходного документа.

### 4. Управление документами

- Получение списка загруженных документов.
- Удаление документа и связанных с ним векторов.
- Получение информации о документе (количество чанков, дата загрузки).

### 5. Настройки индексации

- Конфигурируемый размер чанка (chunk_size).
- Конфигурируемое перекрытие чанков (chunk_overlap).
- Выбор модели эмбеддингов.

## API Эндпоинты

Все эндпоинты версионируются через префикс `/api/v1/`.

### Аутентификация

#### Регистрация

`POST /api/v1/auth/register`

```json
{
  "username": "user@example.com",
  "password": "secure_password"
}
```

Ответ:

```json
{
  "message": "User registered successfully",
  "user_id": "uuid-string"
}
```

#### Логин

`POST /api/v1/auth/login`

```json
{
  "username": "user@example.com",
  "password": "secure_password"
}
```

Ответ:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer",
  "expires_in": 3600
}
```

Все последующие эндпоинты требуют заголовок:
```
Authorization: Bearer <access_token>
```

---

### Документы

#### Загрузка документа

`POST /api/v1/documents/upload`

Content-Type: multipart/form-data

| Параметр | Тип | Описание |
|----------|-----|----------|
| file | file | PDF-файл для загрузки |
| chunk_size | int | Размер чанка в символах (default: 1000) |
| chunk_overlap | int | Перекрытие чанков (default: 200) |

Ответ:

```json
{
  "document_id": "uuid-string",
  "filename": "example.pdf",
  "chunks_count": 42,
  "status": "indexed"
}
```

### Поиск

#### Семантический поиск

`POST /api/v1/search`

```json
{
  "query": "машинное обучение в медицине",
  "top_k": 5,
  "threshold": 0.7
}
```

Ответ:

```json
{
  "results": [
    {
      "document_id": "uuid-string",
      "filename": "research.pdf",
      "chunk_text": "Применение нейронных сетей в диагностике...",
      "score": 0.89,
      "page_number": 12
    }
  ]
}
```

#### Список документов

`GET /api/v1/documents`

Ответ:

```json
{
  "documents": [
    {
      "document_id": "uuid-string",
      "filename": "example.pdf",
      "chunks_count": 42,
      "uploaded_at": "2025-01-15T10:30:00Z",
      "file_size_bytes": 1048576
    }
  ],
  "total": 1
}
```

#### Информация о документе

`GET /api/v1/documents/{document_id}`

Ответ:

```json
{
  "document_id": "uuid-string",
  "filename": "example.pdf",
  "chunks_count": 42,
  "uploaded_at": "2025-01-15T10:30:00Z",
  "file_size_bytes": 1048576,
  "chunk_size": 1000,
  "chunk_overlap": 200,
  "embedding_model": "nomic-embed-text"
}
```

#### Удаление документа

`DELETE /api/v1/documents/{document_id}`

Ответ:

```json
{
  "message": "Document deleted successfully",
  "deleted_chunks": 42
}
```

### Служебные

#### Health Check

`GET /api/v1/health`

Ответ:

```json
{
  "status": "healthy",
  "milvus": "connected",
  "ollama": "connected"
}
```

## Требования к коду

- Соблюдение принципов чистой архитектуры (Clean Architecture)
- Версионирование API (префикс `/api/v1/`)
- Асинхронная обработка запросов
- Валидация входных данных (Pydantic)
- Обработка ошибок и HTTP-статусы
- Наличие unit-тестов (pytest)
- Structured logging с correlation ID
- Graceful Shutdown
- Prometheus-метрики:
  - Количество загруженных документов
  - Время индексации
  - Время поиска
  - Количество запросов
- Документированное API (Swagger)

## Краткий разбор проекта в виде скринкаста

### Что должно быть в видео?

**Введение (1-2 минуты)**
- Название проекта
- Основная цель и функциональность

**Архитектура (2-3 минуты)**
- Структура кода и модули
- Используемые технологии и обоснование выбора
- Схема работы: PDF → Chunks → Embeddings → Milvus → Search

**Демонстрация API (3-5 минут)**
- Регистрация и логин пользователя
- Загрузка PDF-документа
- Выполнение семантического поиска
- Получение списка документов
- Удаление документа

**Мониторинг и логирование (2-3 минуты)**
- Prometheus метрики
- Примеры логов

**Развертывание проекта (2-3 минуты)**
- Docker & Docker Compose
- Запуск через Makefile

**Заключение (1 минута)**
- Итоговый результат
- Возможные улучшения

**Важно:** Видео должно быть кратким (до 10-15 минут).

---